rm(list=ls())

library(ape)
library(plyr)
# library(quadrupen)
library(combinat) # For alpha prior robust estimation
library(robustbase) # For robust fitting of alpha
# library(TreeSim)
library(Matrix)


source("R/simulate.R")
source("R/estimateEM.R")
source("R/init_EM.R")
source("R/E_step.R")
source("R/M_step.R")
source("R/shutoff.R")
source("R/generic_functions.R")
source("R/shifts_manipulations.R")
source("R/plot_functions.R")
source("R/parsimonyNumber.R")
source("R/partitionsNumber.R")
source("R/model_selection.R")

load("../Results/Test_Cases/ericaceae_migale_no_NA_2016-02-11_19-08-45.RData")

## Selected result
plot(res$alpha_max$capushe_outputBM1@DDSE, newwindow = FALSE)

params_estim_EM <- res$alpha_max$DDSE_BM1$params_select
x11()
par(mfrow = c(1,6), mar = c(0, 0, 0, 0), omi = c(0, 0, 0, 0))
for (l in 1:6){
  params <- params_estim_EM
  params$shifts$values <- round(params_estim_EM$shifts$values[l, ], 2)
  params$root.state$value.root <- round(params_estim_EM$root.state$value.root[l], 2)
  plot.data.process.actual(Y.state = trait_matrix_transform[l, ],
                           phylo = phylo, 
                           params = params,
                           # imposed.scale = c(min(Y_data), max(Y_data)),
                           adj.root = 0,
                           automatic_colors = TRUE, 
                           margin_plot = NULL,
                           cex = 1,
                           value_in_box = FALSE,
                           bg_shifts = "azure2",
                           bg_beta_0 = "azure2",
                           plot_ancestral_states = TRUE,
                           ancestral_states = res$alpha_max$DDSE_BM1$Zvar[l, l, ])
  # imposed.scale.node = c(min(res$alpha_max$Djump_BM1$Zhat),
  # max(res$alpha_max$Djump_BM1$Zhat)))
}

## Residuals
times_shared <- compute_times_ca(phylo)
distances_phylo <- compute_dist_phy(phylo)
ntaxa <- length(phylo$tip.label)
nNodes <- phylo$Nnode
p <- 6
moments <- compute_mean_variance.simple(phylo = phylo,
                                        times_shared = times_shared,
                                        distances_phylo = distances_phylo,
                                        process = "scOU",
                                        params_old = params_estim_EM,
                                        masque_data = c(rep(TRUE, (ntaxa) * p),
                                                        rep(FALSE, (nNodes) * p)))
resis <- compute_residuals.simple(phylo = phylo,
                                  Y_data_vec = as.vector(trait_matrix_transform),
                                  sim = moments$sim,
                                  Sigma_YY_chol_inv = moments$Sigma_YY_chol_inv,
                                  missing = rep(FALSE, (ntaxa) * p))

plot(resis,
     main = "Standardized residuals")
lines(x = c(0, length(resis)), y = c(0, 0), col = "green", lty = 2)
lines(x = c(0, length(resis)), y = c(1.96, 1.96), col = "red", lty = 2)
lines(x = c(0, length(resis)), y = c(-1.96, -1.96), col = "red", lty = 2)

hist(resis, 100, probability = TRUE,
     main = "Histogram of standardized residuals",
     xlab = "Standardized residuals")
curve(dnorm(x), add=TRUE, col = "red")

par(mfrow = c(1, 2))
qqnorm(resis, ylim = c(-3, 3))
qqline(resis, col = "red")
qqnorm(resis)
qqline(resis, col = "red")
par(mfrow = c(1,1))

## Outsiders
mean(abs(resis) > 1.96) * 100
outsi <- abs(resis) > 5
outsi_mat <- matrix(outsi, nrow = 6)
outsi_ind <- which(outsi_mat, arr.ind = TRUE)
data.frame(species = colnames(trait_matrix_transform)[outsi_ind[, 2]],
           trait = rownames(trait_matrix_transform)[outsi_ind[, 1]],
           residual = resis[outsi])

## Likelihood
res$alpha_max$results_summary[, c("log_likelihood_init", "log_likelihood")]

source("R/init_EM.R")
results_estim_EM_10bis <- estimateEM(phylo = phylo, 
                               Y_data = trait_matrix_transform, 
                               process = "scOU", 
                               nbr_of_shifts = 10,
                               random.root = FALSE,
                               stationnary.root = FALSE,
                               alpha_known = TRUE,
                               known.selection.strength = alpha_grid[2],
                               tol = list(variance = 10^(-2), 
                                          value.root = 10^(-2),
                                          log_likelihood = 10^(-2)),
                               Nbr_It_Max = 1000,
                               method.init = "lasso"
)

results_estim_EM_9bis <- estimateEM(phylo = phylo, 
                                  Y_data = trait_matrix_transform, 
                                  process = "scOU", 
                                  nbr_of_shifts = 9,
                                  random.root = FALSE,
                                  stationnary.root = FALSE,
                                  alpha_known = TRUE,
                                  known.selection.strength = alpha_grid[2],
                                  tol = list(variance = 10^(-2), 
                                             value.root = 10^(-2),
                                             log_likelihood = 10^(-2)),
                                  Nbr_It_Max = 1000,
                                  method.init = "lasso"
)

resbis <- PhyloEM(phylo = phylo,
                  Y_data = trait_matrix_transform,
                  process = "scOU",
                  random.root = FALSE,
                  K_max = 6,
                  alpha_known = TRUE,
                  alpha = alpha_grid[2],
                  tol = list(variance = 10^(-2), 
                             value.root = 10^(-2),
                             log_likelihood = 10^(-2)),
                  use_previous = FALSE,
                  method.init = "lasso",
                  method.selection = c("BirgeMassart1", "BirgeMassart2"))

resbisbis <- PhyloEM(phylo = phylo,
                     Y_data = trait_matrix_transform,
                     process = "scOU",
                     random.root = FALSE,
                     K_max = 6,
                     alpha_known = TRUE,
                     alpha = alpha_grid[2],
                     tol = list(variance = 10^(-2), 
                                value.root = 10^(-2),
                                log_likelihood = 10^(-2)),
                     use_previous = FALSE,
                     method.init = "lasso",
                     method.selection = c("BirgeMassart1", "BirgeMassart2"))

plot(resbis$alpha_max$capushe_outputBM1@DDSE, newwindow = FALSE)


cbind(c(attr(results_estim_EM_9$params_history[[1]], "log_likelihood")[1], attr(results_estim_EM_10$params_history[[1]], "log_likelihood")[1]),
      c(attr(results_estim_EM_9$params, "log_likelihood")[1], attr(results_estim_EM_10$params, "log_likelihood")[1]))

cbind(c(attr(results_estim_EM_9bis$params_history[[1]], "log_likelihood")[1], attr(results_estim_EM_10bis$params_history[[1]], "log_likelihood")[1]),
      c(attr(results_estim_EM_9bis$params, "log_likelihood")[1], attr(results_estim_EM_10bis$params, "log_likelihood")[1]))

res$alpha_max$results_summary[1:7, c("log_likelihood_init", "log_likelihood")]
resbis$alpha_max$results_summary[, c("log_likelihood_init", "log_likelihood")]


results_estim_EM_11 <- estimateEM(phylo = phylo, 
                                 Y_data = trait_matrix_transform, 
                                 process = "scOU", 
                                 nbr_of_shifts = 13,
                                 random.root = FALSE,
                                 stationnary.root = FALSE,
                                 alpha_known = TRUE,
                                 known.selection.strength = alpha_grid[11],
                                 tol = list(variance = 10^(-2), 
                                            value.root = 10^(-2),
                                            log_likelihood = 10^(-2)),
                                 Nbr_It_Max = 1000,
                                 method.init = "lasso"
)