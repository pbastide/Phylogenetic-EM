<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>An Introduction to the PhylogeneticEM Package &bull; PhylogeneticEM</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">PhylogeneticEM</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/tutorial.html">Tutorial</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/pbastide/PhylogeneticEM">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>An Introduction to the PhylogeneticEM Package</h1>
                        <h4 class="author">Paul Bastide</h4>
            
            <h4 class="date">2016-12-23</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#introduction" class="anchor"> </a></body></html>Introduction</h2>
<p>The <code>PhylogeneticEM</code> package is designed to automatically detect shifts in quatitative traits.</p>
<p>Simply load the package with:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(PhylogeneticEM)</code></pre></div>
</div>
<div id="simulation-of-a-dataset" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#simulation-of-a-dataset" class="anchor"> </a></body></html>Simulation of a dataset</h2>
<p>To show how the functions work, let&rsquo;s first simulate some traits with known parameters.</p>
<p>We use function <code>sim.bd.taxa.age</code> from package <code>TreeSim</code> to simualte a phylogenetic tree.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">17920902</span>)
ntaxa =<span class="st"> </span><span class="dv">80</span>
tree &lt;-<span class="st"> </span>TreeSim::<span class="kw">sim.bd.taxa.age</span>(<span class="dt">n =</span> ntaxa, <span class="dt">numbsim =</span> <span class="dv">1</span>, <span class="dt">lambda =</span> <span class="fl">0.1</span>, <span class="dt">mu =</span> <span class="dv">0</span>,
                                 <span class="dt">age =</span> <span class="dv">1</span>, <span class="dt">mrca =</span> <span class="ot">TRUE</span>)[[<span class="dv">1</span>]]</code></pre></div>
<p>We then choose a set of parameters, using function <code>params_process</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">params &lt;-<span class="st"> </span><span class="kw"><a href="../reference/params_process.html">params_process</a></span>(<span class="st">"OU"</span>,                             ## Process
                         <span class="dt">p =</span> <span class="dv">2</span>,                            ## Dimension
                         <span class="dt">variance =</span> <span class="kw">diag</span>(<span class="fl">0.5</span>, <span class="dv">2</span>, <span class="dv">2</span>) +<span class="st"> </span><span class="fl">0.5</span>, ## Rate matrix
                         <span class="dt">selection.strength =</span> <span class="dv">3</span>,           ## Selection Strength
                         <span class="dt">random =</span> <span class="ot">TRUE</span>,                    ## Root is random
                         <span class="dt">stationary.root =</span> <span class="ot">TRUE</span>,           ## Root is stationary
                         <span class="dt">edges =</span> <span class="kw">c</span>(<span class="dv">29</span>, <span class="dv">89</span>, <span class="dv">127</span>),           ## Positions of the shifts
                         <span class="dt">values =</span> <span class="kw">cbind</span>(<span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">4</span>),           ## Values of the shifts
                                        <span class="kw">c</span>(-<span class="dv">4</span>, -<span class="dv">5</span>),
                                        <span class="kw">c</span>(<span class="dv">5</span>, -<span class="dv">3</span>)))</code></pre></div>
<p>Note that here, we took the selection strength to a scalar matrix, but we could specify a full matrix. Also, we did not specified the ancestral values of the optimum states: these are took to be <span class="math inline">\(0\)</span> by default.</p>
<p>The position of the shifts is specified through to the number of the edge where it occurs. These can be saw using a standart <code>plot</code> fromp package <code>ape</code>. Once the parameters are constructed, we can check the position of the shifts by plotting them:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(params, <span class="dt">phylo =</span> tree, <span class="dt">traits =</span> <span class="dv">1</span>, <span class="dt">value_in_box =</span> <span class="ot">TRUE</span>, <span class="dt">shifts_bg =</span> <span class="st">"white"</span>)
<span class="kw">plot</span>(params, <span class="dt">phylo =</span> tree, <span class="dt">traits =</span> <span class="dv">2</span>, <span class="dt">value_in_box =</span> <span class="ot">TRUE</span>, <span class="dt">shifts_bg =</span> <span class="st">"white"</span>)</code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-1-1.png" width="326.4"><img src="tutorial_files/figure-html/unnamed-chunk-1-2.png" width="326.4"></p>
<p>We can then simulate a process along the tree with these parameters:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/simul_process.html">simul_process</a></span>(params, tree)</code></pre></div>
<p>We can then extract a matrix of simulated data from this object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract.html">extract</a></span>(sim,             ## The simul_process object
                <span class="dt">what =</span> <span class="st">"states"</span>, ## We want the actual values
                <span class="dt">where =</span> <span class="st">"tips"</span>)  ## Only at the tips of the tree</code></pre></div>
<p>The column names of the matrix are set to the tip labels of the tree. By default, the row names are left blank, but, for the sake of the demonstration, let&rsquo;s assume that the two traits are named &ldquo;A&rdquo; and &ldquo;B&rdquo;:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">rownames</span>(data) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>)</code></pre></div>
<p>Finally, we can plot the simulated process on the tree to see what it looks like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(params, <span class="dt">phylo =</span> tree, <span class="dt">data =</span> data)</code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
</div>
<div id="inference" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#inference" class="anchor"> </a></body></html>Inference</h2>
<p>In this section, we take the traits as simulated by function <code>simul_process</code>, and use function <code>PhyloEM</code> for the inference of the parameters.</p>
<p>To make things more interesting, let&rsquo;s assume that we have some missing data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nMiss &lt;-<span class="st"> </span><span class="kw">floor</span>(ntaxa *<span class="st"> </span><span class="dv">2</span> *<span class="st"> </span><span class="fl">0.1</span>)                       ## 10% of missing data
miss &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="dv">1</span>:(<span class="dv">2</span> *<span class="st"> </span>ntaxa), nMiss, <span class="dt">replace =</span> <span class="ot">FALSE</span>) ## sample missing randomly
chars &lt;-<span class="st"> </span>(miss -<span class="st"> </span><span class="dv">1</span>) %%<span class="st"> </span><span class="dv">2</span> +<span class="st"> </span><span class="dv">1</span>                          ## Trace back rows and columns
tips &lt;-<span class="st"> </span>(miss -<span class="st"> </span><span class="dv">1</span>) %/%<span class="st"> </span><span class="dv">2</span> +<span class="st"> </span><span class="dv">1</span>
for (i in <span class="dv">1</span>:nMiss){
  data[chars[i], tips[i]] &lt;-<span class="st"> </span><span class="ot">NA</span>                       ## Forget some values
}</code></pre></div>
<p>By default, the inference is done on an automatically computed grid of alpha values. Here, to keep the computations to a minimum, we will only use <span class="math inline">\(2\)</span> values for alpha, including the true value. In a true application however, a grid with <span class="math inline">\(10\)</span> values of <span class="math inline">\(\alpha\)</span> is automatically chosen.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Grid on alpha
alpha_grid &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)

## Run algorithm
res &lt;-<span class="st"> </span><span class="kw"><a href="../reference/PhyloEM.html">PhyloEM</a></span>(<span class="dt">phylo =</span> tree,
               <span class="dt">Y_data =</span> data,
               <span class="dt">process =</span> <span class="st">"scOU"</span>,                   ## scalar OU model
               <span class="dt">random.root =</span> <span class="ot">TRUE</span>,                 ## Root is stationary (true model)
               <span class="dt">stationary.root =</span> <span class="ot">TRUE</span>,
               <span class="dt">alpha =</span> alpha_grid,                 ## On a grid of alpha
               <span class="dt">K_max =</span> <span class="dv">10</span>,                         ## Maximal number of shifts
               <span class="dt">parallel_alpha =</span> <span class="ot">TRUE</span>,              ## This can be set to TRUE for
               <span class="dt">Ncores =</span> <span class="dv">2</span>)                         ## parallel computations</code></pre></div>
<pre><code>## There are some equivalent solutions to the set of shifts selected by the Djump_BM1 method.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res</code></pre></div>
<pre><code>## Result of the PhyloEM algorithm.
## Selected parameters by the default method:
## 2 dimensional scOU process with a random stationary root.
## 
## Root expectations:
## [1] -0.01260485 -0.01637370
## 
## Root variance:
##           [,1]     [,2]
## [1,] 0.1695455 0.122572
## [2,] 0.1225720 0.172665
## 
## Process variance:
##           [,1]      [,2]
## [1,] 1.0172732 0.7354322
## [2,] 0.7354322 1.0359902
## 
## Process selection strength:
##      [,1] [,2]
## [1,]    3    0
## [2,]    0    3
## 
## Process root optimal values:
## [1] -0.01260485 -0.01637370
## 
## Shifts positions on branches: 127, 89, 29 
## Shifts values:
##            127        89       29
## [1,]  4.911583 -4.315716 4.693763
## [2,] -2.865227 -5.089515 3.833946
## 
## 
## 
## See help to see all plotting and handling functions.</code></pre>
<p>The fitted object contains the infered parameters for every values of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(K\)</span>, as well as the parameters selected by the various model selection criteria.</p>
<p>Here, we can see that the original shifts were recovered by the model selection procedure. We can plot the obtained solution, as shown below. The infered states a the tips are shown in dotted lines. Notice that they are coherent with the positions of the shifts that we found.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(res)</code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>Above, we plotted the solution given by the LINselect method (the default). But we might want to see the solution given by another selection method, such as the slope heuristic. In that case, we just need to run:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(res, <span class="dt">params =</span> <span class="kw"><a href="../reference/params_process.html">params_process</a></span>(res, <span class="dt">method.selection =</span> <span class="st">"DDSE"</span>))</code></pre></div>
<p>where we extracted the parameters with the method <code>params_process</code>. Here, the results are the same.</p>
<p>We can also extract the solution for a given number of shifts and/or a given value of alpha. For instance, we can see that in this simple case, the infered position of the shifts is robust to the value of the selection strength:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(res, <span class="dt">params =</span> <span class="kw"><a href="../reference/params_process.html">params_process</a></span>(res, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">alpha =</span> <span class="dv">1</span>))</code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-6-1.png" width="672"> The infered shifts values however are quite different:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/params_process.html">params_process</a></span>(res, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">alpha =</span> <span class="dv">1</span>)$shifts</code></pre></div>
<pre><code>## $edges
## [1] 127  89  29
## 
## $values
##           [,1]      [,2]     [,3]
## [1,]  7.721542 -7.045950 7.789901
## [2,] -4.547188 -8.427789 6.278500
## 
## $relativeTimes
## [1] 0 0 0</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/params_process.html">params_process</a></span>(res, <span class="dt">K =</span> <span class="dv">3</span>, <span class="dt">alpha =</span> <span class="dv">3</span>)$shifts</code></pre></div>
<pre><code>## $edges
## [1] 127  89  29
## 
## $values
##           [,1]      [,2]     [,3]
## [1,]  4.911583 -4.315716 4.693763
## [2,] -2.865227 -5.089515 3.833946
## 
## $relativeTimes
## [1] 0 0 0</code></pre>
</div>
<div id="equivalent-solutions" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#equivalent-solutions" class="anchor"> </a></body></html>Equivalent Solutions</h2>
<p>When there are too many shifts, the solutin might not be identifiable. For instance here, if we take the (degenerate) solution with <span class="math inline">\(8\)</span> shifts, we get this warning:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">params_8 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/params_process.html">params_process</a></span>(res, <span class="dt">K =</span> <span class="dv">8</span>)</code></pre></div>
<pre><code>## Warning in params_process.PhyloEM(res, K = 8): There are several equivalent
## solutions for this shift position.</code></pre>
<p>And we can plot all the equivalent shifts allocations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw"><a href="../reference/equivalent_shifts.html">equivalent_shifts</a></span>(tree, params_8))</code></pre></div>
<p><img src="tutorial_files/figure-html/unnamed-chunk-9-1.png" width="768"> the default only shows the shifts values for the first trait.</p>
<!-- Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format: -->
<!-- - Never uses retina figures -->
<!-- - Has a smaller default figure size -->
<!-- - Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style -->
<!-- ## Vignette Info -->
<!-- Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette. -->
<!-- ## Styles -->
<!-- The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows: -->
<!--     output:  -->
<!--       rmarkdown::html_vignette: -->
<!--         css: mystyles.css -->
<!-- ## Figures -->
<!-- The figure sizes have been customised so that you can easily put two images side-by-side.  -->
<!-- ```{r, fig.show='hold'} -->
<!-- plot(1:10) -->
<!-- plot(10:1) -->
<!-- ``` -->
<!-- You can enable figure captions by `fig_caption: yes` in YAML: -->
<!--     output: -->
<!--       rmarkdown::html_vignette: -->
<!--         fig_caption: yes -->
<!-- Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**. -->
<!-- ## More Examples -->
<!-- You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`. -->
<!-- ```{r, echo=FALSE, results='asis'} -->
<!-- knitr::kable(head(mtcars, 10)) -->
<!-- ``` -->
<!-- Also a quote using `>`: -->
<!-- > "He who gives up [code] safety for [code] speed deserves neither." -->
<!-- ([via](https://twitter.com/hadleywickham/status/504368538874703872)) -->
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked"><li><a href="#introduction">Introduction</a></li>
      <li><a href="#simulation-of-a-dataset">Simulation of a dataset</a></li>
      <li><a href="#inference">Inference</a></li>
      <li><a href="#equivalent-solutions">Equivalent Solutions</a></li>
      </ul></div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Paul Bastide.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer></div>

  </body></html>
